<html>

<head>
  <title>TensorFlow.js 娱乐版的双色球在线预测 | 「A4纸」前端开发博客</title>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport" />
  <style>
    .tips {
      font-weight: 700;
      font-size: 20px;
      display: inline-block;
    }

    .animated {
      animation-duration: 1s;
      animation-fill-mode: both;
    }

    .animated.infinite {
      animation-iteration-count: infinite;
    }

    @keyframes pulse {
      from {
        transform: scale3d(1, 1, 1);
      }

      50% {
        transform: scale3d(1.03, 1.03, 1.03);
      }

      to {
        transform: scale3d(1, 1, 1);
      }
    }

    .pulse {
      animation-name: pulse;
    }

    #micro-out-div i,
    b {
      border-radius: 50%;
      font-style: normal;
      font-weight: 700;
      color: #fff;
      height: 30px;
      width: 30px;
      text-align: center;
      line-height: 30px;
      display: inline-block;
    }

    #micro-out-div i {
      background-color: red;
    }

    #micro-out-div b {
      background-color: blue;
    }
  </style>
</head>

<body>
  <h4>
    <a href="/fe" style="text-decoration: none; font-size: 16px;">首页</a>
    | TensorFlow.js 娱乐版的双色球在线预测
  </h4>
  <p style="font-size: 12px; color: #999;">
    声明：本工具仅供学习与娱乐用途，不作为个人行为、行动建议，个人行为行动产生任何法律责任后果自负，与本站无关
  </p>
  <hr />
  <select name="model" style="
        display: inline-block;
        min-width: 300px;
        width: 300px;
        max-width: 100%;
        margin-left: 5px;
        min-height: 30px;
        margin-top: 10px;
        border-color: #c3cad1;
        border-radius: 4px;
        border-width: 1px;
      " id="model">
    <option value="">请选择历史数据模型训练（model）...</option>
    <option name="model" value="00000-10000">期号 00000-10000 </option>
    <option name="model" value="10000-20000">期号 10000-20000 </option>
    <option name="model" value="00000-20000">期号 00000-20000 </option>
    <option name="model" value="20000-20042">期号 20000-20042 </option>
  </select>
  <input type="number" name="round" style="
        display: inline-block;
        min-width: 200px;
        width: 200px;
        max-width: 100%;
        margin-left: 5px;
        min-height: 30px;
        margin-top: 10px;
        border-color: #c3cad1;
        border-radius: 4px;
        border-width: 1px;
      " id="epochs" placeholder="请输入学习次数（epochs）..." min="1" />
  <input type="number" name="round" style="
        display: inline-block;
        min-width: 200px;
        width: 200px;
        max-width: 100%;
        margin-left: 5px;
        min-height: 30px;
        margin-top: 10px;
        border-color: #c3cad1;
        border-radius: 4px;
        border-width: 1px;
      " id="round" placeholder="请输入待预测的期号..." min="20043" />
  <button style="
        display: inline-block;
        min-width: 100px;
        width: 100px;
        max-width: 100%;
        margin-left: 5px;
        min-height: 30px;
        margin-top: 10px;
        border-color: #c3cad1;
        border-radius: 4px;
        border-width: 1px;
        text-align: center;
        cursor: pointer;
      " id="btn">
    开始预测
  </button>
  <hr />
  <div id="micro-out-div">
    <span class="tips pulse animated infinite">正在预测...</span>
  </div>
  <div id="table" style="display: none;"></div>
  <footer style="text-align: center; color: #999; padding-top: 200px;">
    郑重提示：彩票有风险，投注需谨慎！禁止向未满18周岁的青少年出售彩票！
  </footer>
  <script src="https://libs.baidu.com/jquery/1.11.3/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
  <script>
    $(document).ready(function () {
      runTf('00000-20000', 1, 29999) // 默认打开运行预测 训练模型期号数据是 00000-20000，学习次数是 1 次，预测的期号是 29999
      $('#btn').click(function () { // 点击按钮绑定处理
        const modelVal = $('#model').val()
        const epochsVal = $('#epochs').val()
        const roundVal = $('#round').val()
        const tips =
          '<span class="tips pulse animated infinite">正在预测...</span>'
        if (!modelVal) {
          alert('请先选择历史数据模型训练（model）')
          return false
        }
        if (!epochsVal) {
          alert('请先输入学习次数（epochs）')
          return false
        }
        if (!roundVal) {
          alert('请先输入待预测的期号')
          return false
        }
        $('#micro-out-div').html(tips)
        runTf(modelVal, Number(epochsVal), Number(roundVal))
      })
      function runTf(historyModel, epochs, round) { // 关键函数
        $('#table').load(`./ssq/history-${historyModel}.htm`, function () { // 加载相应的训练模型数据，来源于 500 彩票 http://kaijiang.500.com
          const rawArr = []
          const xsArr = []
          const yxArr = []
          // 通过 dom 操作把源数据由 table 中抽取出来
          $('#table .t_tr1').each(function () {
            let This = $(this)
            let str = ''
            This.find('td').each(function (n) {
              if (n === 0) {
                str += $(this).text()
              } else if (n < 8 && n > 0) {
                str += '|' + $(this).text()
              }
            })
            let arr = str.split('|')
            arr = arr.map((_) => Number(_))
            rawArr.push(arr)
            xsArr.push(arr[0])
            yxArr.push(arr.slice(1))
          })

          async function run() { // 关键代码
            // Sequential 序贯模型，序贯模型是函数式模型的简略版，为最简单的线性、从头到尾的结构顺序，不分叉，是多个网络层的线性堆叠。
            const model = tf.sequential()
            // 使用.add() 方法将各层添加到模型中
            model.add(tf.layers.dense({ units: 7, inputShape: [1] })) // Dense，支持通过参数 inputShape 指定输入尺寸，units: 该层的神经单元结点数（输出结果是 7 个球）
            // compile({loss, optimizer, metrics}) 编译模型，定义损失函数，优化函数，绩效评估函数
            model.compile({ loss: 'binaryCrossentropy', optimizer: 'sgd' }) // metrics 可参考：https://js.tensorflow.org/api/1.7.2/#Metrics
            console.log('开始，gogogo!')
            // 下面其实定义使用 tensor / tensor1d / tensor2d 都没关系，最终 tensor1d / tensor2d ...3d... 都跟 tensor 效果一样，语法糖来的
            const xs = tf.tensor(xsArr) // 定义一个张量（这里是历史期号）
            console.log(xs.shape) // 打印输入尺寸
            const ys = tf.tensor(yxArr) // 定义一个张量（这里是上面 xs 的历史期号对应所有的开奖结果）
            console.log(ys.shape) // 打印输入尺寸
            console.time('训练时间')
            console.log('开始训练...')
            await model.fit(xs, ys, { epochs: epochs }) // 导入数据进行训练 可参考：https://js.tensorflow.org/api/1.7.2/#tf.LayersModel.fit
            console.timeEnd('训练时间')
            console.log('结束训练')
            console.time('预测时间')
            console.log('开始预测...')
            const predicted = model // 为什么叫娱乐版的呢？因为下面出来的结果太失望了，要自己重新处理
              .predict(tf.tensor2d([round], [1, 1])) // 预测自己输入的期号为 round 的结果
              .abs() // 取绝对值
              .floor() // 去掉小数点
              .dataSync() // 得到的是一个 Float32Array，如果学习次数 epochs 太少的话，结果类似 [20661, 28071, 7391, 10978, 7883, 9646, 5441]，WTF！太差了吗？
              .map((_, n) => { // 自己按号码规则求余优化成最终结果
                return n !== 6 ? _ % 33 || 33 : _ % 16 || 16
              })
            const obj = {} // 判断出来的红球有没有重复
            predicted.forEach((_, n) => {
              if (n !== 6) {
                obj[_] = 1
              }
            })
            if (Object.keys(obj).length < 6) { // 什么？出来的红球有重复？帮我重新预测吧 
              run()
              return false
            }
            // 下面是 dom 操作，打印预测结果 
            const predictedHtml = [...predicted].map((_, n) => {
              return n !== 6 ? `<i>${_}</i>` : `<b>${_}</b>`
            })
              .join(' | ')
            $('#micro-out-div').html(
              '期号 ' + round + ' 预测结果为：' + predictedHtml
            )
            console.timeEnd('预测时间')
            console.log('结束预测')
          }
          run()
        })
      }
    })
  </script>
</body>

</html>